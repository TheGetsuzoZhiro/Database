import java.io.BufferedReader;
import java.io.InputStreamReader;
import java.net.HttpURLConnection;
import java.net.URL;
import java.net.URLEncoder;
import java.util.Random;
import java.util.Scanner;

public class GPTSession {
    private static String sessionId = null; // hanya sekali untuk 1 user

    public static void main(String[] args) {
        Scanner scanner = new Scanner(System.in);

        // Buat sessionId sekali saja
        if (sessionId == null) {
            sessionId = "USER" + new Random().nextInt(1000000);
            System.out.println("üìå Session ID dibuat: " + sessionId);
        }

        while (true) {
            System.out.print("\nüí¨ Masukkan pertanyaan (atau 'exit' untuk keluar): ");
            String query = scanner.nextLine();

            if (query.equalsIgnoreCase("exit")) {
                System.out.println("üö™ Program dihentikan.");
                break;
            }

            try {
                String encodedQuery = URLEncoder.encode(query, "UTF-8");

                String apiUrl = "https://api.neoxr.eu/api/gpt4-session?q="
                        + encodedQuery
                        + "&session=" + sessionId
                        + "&apikey=GetsuzoCp7";

                HttpURLConnection conn = (HttpURLConnection) new URL(apiUrl).openConnection();
                conn.setRequestMethod("GET");
                conn.setRequestProperty("User-Agent", "Java-NetBeans");

                BufferedReader in = new BufferedReader(new InputStreamReader(conn.getInputStream()));
                StringBuilder response = new StringBuilder();
                String inputLine;
                while ((inputLine = in.readLine()) != null) {
                    response.append(inputLine);
                }
                in.close();

                // Bersihin hasil JSON mentah
                String res = response.toString();

                // Cari "data" atau "result" manual
                String answer = "";
                if (res.contains("\"data\"")) {
                    answer = ambilValue(res, "data");
                } else if (res.contains("\"result\"")) {
                    answer = ambilValue(res, "result");
                } else {
                    answer = res;
                }

                // Tampilkan clean
                System.out.println("\nü§ñ GPT:");
                System.out.println(answer);

            } catch (Exception e) {
                System.out.println("‚ùå Gagal mengambil jawaban: " + e.getMessage());
            }
        }

        scanner.close();
    }

    // Fungsi untuk ambil value dari JSON string mentah
    private static String ambilValue(String json, String key) {
        try {
            int start = json.indexOf("\"" + key + "\"");
            if (start == -1) return json;
            start = json.indexOf(":", start) + 1;
            while (start < json.length() && (json.charAt(start) == ' ' || json.charAt(start) == '\"')) start++;
            int end = start;
            boolean escape = false;
            while (end < json.length()) {
                char c = json.charAt(end);
                if (c == '\"' && !escape) break;
                escape = (c == '\\') && !escape;
                end++;
            }
            return json.substring(start, end).replace("\\n", "\n").replace("\\\"", "\"");
        } catch (Exception e) {
            return json;
        }
    }
}
